## 사용자의 액션 수 집계하기 

### 액션 수와 비율을 계산하는 쿼리
```sql
WITH stats AS(
  SELECT COUNT(DISTINCT session) AS total_uu
  FROM action_log
)
SELECT l.action
-- 액션 UU
	,COUNT(DISTINCT l.session) AS action_uu
-- 액션의 수     
    ,COUNT(1) AS action_count
-- 전체 UU
	,s.total_uu
-- 사용률 : 액션 uu / 전체 uu 
	,COUNT(DISTINCT l.session)*100.0 / s.total_uu AS usage_rate
-- 1인당 액션 수 : 액션 수 / 액션 uu
	,COUNT(1)*1.0/COUNT(DISTINCT l.session) AS count_per_user    
FROM action_log AS l 
```
### 로그인 상태를 판별하는 쿼리 
```sql
WITH action_log_with_status AS(
  
  SELECT   session
          ,user_id
          ,action
          -- user_id가 NULL 또는 빈 문자가 아닌 경우 login이라고 판정하기
          ,CASE WHEN COALESCE(user_id,'')<>'' THEN 'login' ELSE 'guest' END
           AS login_status
  FROM action_log
  )
```
### 로그인 상태에 따라 액션 수 등을 따로 집계하는 쿼리 
```sql
WITH action_log_with_status AS(
  
  SELECT   session
          ,user_id
          ,action
          -- user_id가 NULL 또는 빈 문자가 아닌 경우 login이라고 판정하기
          ,CASE WHEN COALESCE(user_id,'')<>'' THEN 'login' ELSE 'guest' END
           AS login_status
  FROM action_log
  )
SELECT 
	 COALESCE(action, 'all') AS action
	,COALESCE(login_status,'all') AS login_status
    ,COUNT(DISTINCT session) AS action_uu
    ,COUNT(1) AS action_count
FROM action_log_with_status
GROUP BY ROLLUP(action, login_status)
-- 로그인 상태에 따라 액션 수를 따로 집계
```
### 회원과 비회원을 구분해서 집계하기 

```sql
WITH action_log_with_status AS(
  
  SELECT   session
          ,user_id
          ,action
          -- 로그를 타임스탬프 순서로 나열하고, 한번이라도 로그인한 사용자일 경우
  		  -- 이후의 모든 로그 상태를 member로 설정
  		  ,CASE
  			WHEN
  				COALESCE(MAX(user_id)
  				OVER(PARTITION BY session ORDER BY stamp
                     ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
  				,'') <> ''
                THEN 'member'
            ELSE 'none'
           END AS member_status
          ,stamp 
  FROM action_log
  )
SELECT * 
FROM action_log_with_status
```
## 연령별 구분 집계하기 

### 사용자의 생일을 계산하는 쿼리 
```sql
WITH mst_users_with_int_birth_date AS(
  SELECT
      *
      -- 특정 날짜(2017년 1월 1일)의 정수 표현
     ,20170101 AS int_specific_date
      -- 문자열로 구성된 생년월일을 정수 표현으로 변환하기
     ,CAST(replace(substring(birth_date,1,10),'-','' ) AS integer) AS int_birth_date
  FROM mst_users

),mst_users_with_age AS (
  SELECT
  	*
   -- 특정 날짜(2017년 1월 1일)의 나이
   ,FLOOR((int_specific_date -  int_birth_date) / 10000) AS age
  FROM mst_users_with_int_birth_date

)
SELECT 
	user_id
   ,sex
   ,birth_date
   ,age
FROM mst_users_with_age;
```

#### CAST 
- 형 변환 함수 
- CAST(컬럼명, 값 AS 변경하려는 TYPE명)
- 영단어 뜻을 찾아보니 주조하다, 거푸집 이런 것들이 있어서 비슷한 결이 아닐까 싶다. 

#### Q : 왜 굳이 substring으로 잘라줄까? 
```CAST(replace(substring(birth_date,1,10),'-','' ) AS integer) AS int_birth_date```
- birth_date 어차피 1에서 10인데..?
- 이 날짜를 이 특정 형식으로 변환하는 이유는 날짜 형식의 다양성과 관련된 잠재적인 문제를 방지하고 날짜의 정수 표현에 표준화된 접근을 보장하기 위함입니다. 이렇게 함으로써 날짜 형식의 변형과 관련된 잠재적인 문제를 방지하고 날짜의 정수 표현에 표준화된 접근을 보장합니다.
  - ChatGPT가 그렇대
 
#### Floor
- 말 그대로 바닥, 마루
- 소수점 무시

## 사용자의 방문 빈도 집계하기   
