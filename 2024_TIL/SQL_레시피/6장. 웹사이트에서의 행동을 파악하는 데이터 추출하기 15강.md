# 15강 사이트 내의 사용자 행동 파악하기 
## 1. 입구 페이지와 출구 페이지 집계하기 

### FIRST_VALUE와 LAST_VALUE
- 첫번째 값, 마지막 값 
```sql
WITH activity_log_with_landing_exit AS(
  SELECT 
         session
        ,path
        ,stamp
        ,FIRST_VALUE(path) OVER(PARTITION BY session ORDER BY stamp ASC
                               ROWS BETWEEN UNBOUNDED PRECDING 
                               AND UNBOUNDED FOLLOWING
                               ) AS landing 
    -- 윈도우 함수에서 ORDER BY를 지정한 경우의 윈도함수 파티션은 디폴트로 첫 행부터 현재 행까지 계산 (누적합 계산할 때와 마찬가지로), But 우리는 입구 페이지와 출구 페이지를 찾고 싶기 때문에
    -- ROWS BETWEEN~ 구문을 사용해 각 세션 내부의 모든 행을 대상으로 지정                                
        , LAST_VALUE(path) OVER(PARTITION BY session ORDER BY stamp ASC
                                ROWS BETWEEN UNBOUNDED PRECEDING 
                                AND UNBOUNDED FOLLOWING
                                ) AS exit
    FROM activity_log
)
```
[레퍼런스](https://guseowhtjs.tistory.com/entry/SQL-Server-%EC%B2%AB-%EB%B2%88%EC%A7%B8-%EA%B0%92-%ED%95%A8%EC%88%98-FIRSTVALUE-function)

### 각 세션의 입구 페이지와 출구 페이지를 기반으로 방문 횟수를 추출하는 쿼리 

```sql
WITH activity_log_with_landing_exit AS(
  SELECT 
         session
        ,path
        ,stamp
        ,FIRST_VALUE(path) OVER(PARTITION BY session ORDER BY stamp ASC
                               ROWS BETWEEN UNBOUNDED PRECEDING 
                               AND UNBOUNDED FOLLOWING
                               ) AS landing 
    -- 윈도우 함수에서 ORDER BY를 지정한 경우의 윈도함수 파티션은 디폴트로 첫 행부터 현재 행까지 계산 (누적합 계산할 때와 마찬가지로), But 우리는 입구 페이지와 출구 페이지를 찾고 싶기 때문에
    -- ROWS BETWEEN~ 구문을 사용해 각 세션 내부의 모든 행을 대상으로 지정                                
        , LAST_VALUE(path) OVER(PARTITION BY session ORDER BY stamp ASC
                                ROWS BETWEEN UNBOUNDED PRECEDING 
                                AND UNBOUNDED FOLLOWING
                                ) AS exit
    FROM activity_log
)
, landing_count AS(
    -- 입구 페이지의 방문 횟수 집계하기 
  SELECT landing AS path
        ,COUNT(DISTINCT session) AS count
  FROM activity_log_with_landing_exit
  GROUP BY landing 
)
, exit_count AS(
  -- 출구 페이지의 방문 횟수 집계하기
  SELECT exit AS path
        ,COUNT(DISTINCT session) AS count  
  FROM activity_log_with_landing_exit
  GROUP BY exit
)   
-- 입구 페이지와 출구 페이지 방문 횟수 결과를 한꺼번에 출력하기

SELECT 'landing' AS type, * FROM landing_count
UNION ALL
SELECT 'exit' AS type , * FROM exit_count;
```

### 어디에서 조회를 시작해서 어디에서 이탈하는지 집계하기 

```sql
WITH activity_log_with_landing_exit AS(
  SELECT 
         session
        ,path
        ,stamp
        ,FIRST_VALUE(path) OVER(PARTITION BY session ORDER BY stamp ASC
                               ROWS BETWEEN UNBOUNDED PRECEDING 
                               AND UNBOUNDED FOLLOWING
                               ) AS landing 
    -- 윈도우 함수에서 ORDER BY를 지정한 경우의 윈도함수 파티션은 디폴트로 첫 행부터 현재 행까지 계산 (누적합 계산할 때와 마찬가지로), But 우리는 입구 페이지와 출구 페이지를 찾고 싶기 때문에
    -- ROWS BETWEEN~ 구문을 사용해 각 세션 내부의 모든 행을 대상으로 지정                                
        , LAST_VALUE(path) OVER(PARTITION BY session ORDER BY stamp ASC
                                ROWS BETWEEN UNBOUNDED PRECEDING 
                                AND UNBOUNDED FOLLOWING
                                ) AS exit
    FROM activity_log
)

SELECT  landing 
  	  , exit
      , COUNT(DISTINCT session) AS count
FROM activity_log_with_landing_exit
GROUP BY landing,exit 
```

